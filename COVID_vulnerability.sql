/* CLEANING THE DATA */

/* Beginning with the Covid Vulnerability Crosswalk dataset, only five of the columns will be used for analysis.
	These columns are renamed using the "Design" option and the extra columns excluded: */  

select * from PortfolioProjects..[COVID-19_Community_Vulnerability]

alter table PortfolioProjects..[COVID-19_Community_Vulnerability] 
drop column if exists ST_ABBR, 
	 column if exists STCNTY,
	 column if exists FIPS,
	 column if exists [LOCATION],
	 column if exists [Total Score],
	 column if exists [Max Possible Score],
	 column if exists [HHA Score],
	 column if exists [Low Income Area (LIA) County SAIPE- Score],
	 column if exists [Low Income Area (LIA) Census Tract (Poverty Percentage)],
	 column if exists [Low Income Area (LIA) Census Tract - Score],
	 column if exists [Tribal Community_(1 if yes)],
	 column if exists [Tribal Community_Score (Geographic Only)],
	 column if exists Rural,
	 column if exists [Rural - Score]

/* Extra spaces (if any) are removed from string columns: */

update PortfolioProjects..[COVID-19_Community_Vulnerability]
set [State] = trim([State])

update PortfolioProjects..[COVID-19_Community_Vulnerability]
set County = trim(County)

/* Uniqueness of Hardest_Hit_Area status and County_Poverty_Proportion are verified per county (the original dataset
	lists entries by census tract; there are multiple census tracts per county): */

;with hha_CTE as (select County_FIPS, count(distinct Hardest_Hit_Area) unique_HHA_count 
	from PortfolioProjects..[COVID-19_Community_Vulnerability] group by County_FIPS)
	select distinct unique_HHA_count from hha_CTE

;with percent_CTE as (select County_FIPS, count(distinct County_Poverty_Proportion) unique_pct_count 
	from PortfolioProjects..[COVID-19_Community_Vulnerability] group by County_FIPS)
	select distinct unique_pct_count from percent_CTE

/* Hardest_Hit_Area and County_Poverty_Proportion are unique per county. Duplicate entries are removed, 
	leaving one entry per county: */

;with unique_CTE as (select *, ROW_NUMBER() over (partition by County_FIPS order by County_FIPS) row_num
	from PortfolioProjects..[COVID-19_Community_Vulnerability])
	delete from unique_CTE where row_num > 1 

/* The unique values of Hardest_Hit_Area, describing the pervasiveness of COVID in the corresponding
	counties, are now verified. There are 7 in total: */

select distinct Hardest_Hit_Area from PortfolioProjects..[COVID-19_Community_Vulnerability]
 
/* The values of Hardest_Hit_Area, ordinal in nature, are assigned the values 1-7 in the new added column HHA_Rank 
	with 7 being most severe. Per the Areas of Concern (AOC) continuum issued by the Center for Disease Control located at 
	https://www.porh.psu.edu/wp-content/uploads/CDC-Hotspot-Definition.pdf, a Sustained Hotspot Area is where
	infections are most rampant. This category is assigned the number 7. */

alter table PortfolioProjects..[COVID-19_Community_Vulnerability]
drop column if exists HHA_Rank

alter table PortfolioProjects..[COVID-19_Community_Vulnerability]
add HHA_Rank int

GO

update PortfolioProjects..[COVID-19_Community_Vulnerability]
set HHA_Rank = case when Hardest_Hit_Area = 'SustainedHotspot' then 7
					when Hardest_Hit_Area = 'Hotspot' then 6
					when Hardest_Hit_Area = 'EmergingHotspot' then 5
					when Hardest_Hit_Area = 'HighBurdenResolving' then 4
					when Hardest_Hit_Area = 'ModerateBurden' then 3
					when Hardest_Hit_Area = 'ModerateBurdenResolving' then 2
					when Hardest_Hit_Area = 'LowBurden' then 1 end 

/* Checking for nulls in each column: */

select 
	sum(case when [State] is null then 1 else 0 end) as State_Nulls,
	sum(case when County is null then 1 else 0 end) as County_Nulls,
	sum(case when County_FIPS is null then 1 else 0 end) as FIPS_Nulls,
	sum(case when Hardest_Hit_Area is null then 1 else 0 end) as HHA_Nulls,
	sum(case when County_Poverty_Proportion is null then 1 else 0 end) as CPP_Nulls,
	sum(case when HHA_Rank is null then 1 else 0 end) as Rank_Nulls
	from PortfolioProjects..[COVID-19_Community_Vulnerability] 

/* There are no nulls. The range of the County_Poverty_Proportion is now determined: */

select min(County_Poverty_Proportion) Min_CPP, max(County_Poverty_Proportion) Max_CPP 
	from PortfolioProjects..[COVID-19_Community_Vulnerability]

/* All proportions are between 0 and 1. The number of unique states is now verified: */

select count(distinct [State]) State_Count from PortfolioProjects..[COVID-19_Community_Vulnerability]

select distinct [State] from PortfolioProjects..[COVID-19_Community_Vulnerability] order by [State]

/* There are 51 distinct states, including District of Columbia. */

/* Moving to the population dataset, five columns are retained for analysis. These are renamed and the remainder excluded: */

select * from PortfolioProjects..Average_Household_Size_and_Population

alter table PortfolioProjects..Average_Household_Size_and_Population 
drop column if exists FID, 
	 column if exists COUNTYNS,
	 column if exists ALAND,
	 column if exists AWATER,
	 column if exists [NAME],
	 column if exists [STATE],
	 column if exists B25010_001M,
	 column if exists B25010_002E,
	 column if exists B25010_002M,
	 column if exists B25010_003E,
	 column if exists B25010_003M,
	 column if exists B01001_001M,
	 column if exists created_user,
	 column if exists created_date,
	 column if exists last_edited_user,
	 column if exists last_edited_date,
	 column if exists B01001_calc_PopDensityM,
	 column if exists SHAPE_Length,
	 column if exists SHAPE_Area 

/* The uniqueness of the county entries is verified: */

select count(distinct GEOID) Unique_GEOID_Count from PortfolioProjects..Average_Household_Size_and_Population

/* There is exactly one county per entry. The next step is converting Population_Density to two decimal places: */

update PortfolioProjects..Average_Household_Size_and_Population
set Population_Density = CONVERT(DECIMAL(10,2), Population_Density)

/* The ranges of the measuring variables are verified: */

select concat(min(Average_Household_Size), ' - ', max(Average_Household_Size)) Avg_Household_Range,
	   concat(min(Total_Population), ' - ', max(Total_Population)) Pop_Range,
	   concat(min(Population_Density), ' - ', max(Population_Density)) Pop_Density_Range 
	   from PortfolioProjects..Average_Household_Size_and_Population

/* Checking for nulls in each column: */

select 
	sum(case when GEOID is null then 1 else 0 end) as FIPS_Nulls,
	sum(case when Average_Household_Size is null then 1 else 0 end) as Household_Nulls,
	sum(case when Total_Population is null then 1 else 0 end) as Pop_Nulls,
	sum(case when Population_Density is null then 1 else 0 end) as Density_Nulls
	from PortfolioProjects..Average_Household_Size_and_Population

/* No nulls are found. */ 

/* The two datasets are now inner-joined on the county identifier column
	([COVID-19_Community_Vulnerability].County_FIPS = Average_Household_Size_and_Population.GEOID). The data is at the level
	of the county and there is one entry per county in each dataset. */

SELECT [State], County, County_FIPS, Hardest_Hit_Area, County_Poverty_Proportion, HHA_Rank, Average_Household_Size,
	Total_Population, Population_Density
FROM PortfolioProjects..[COVID-19_Community_Vulnerability]
INNER JOIN PortfolioProjects..Average_Household_Size_and_Population
ON 
PortfolioProjects..[COVID-19_Community_Vulnerability].County_FIPS = PortfolioProjects..Average_Household_Size_and_Population.GEOID

/* 3,141 rows are left; these are all of the rows from the COVID Vulnerability dataset. A view is created for 
	further reference: */

if exists(select * from sys.views where name = 'COVID_population' and type = 'v') drop view COVID_population
go
create view COVID_population as (
	SELECT [State], County, County_FIPS, Hardest_Hit_Area, County_Poverty_Proportion, HHA_Rank, Average_Household_Size,
	Total_Population, Population_Density
FROM PortfolioProjects..[COVID-19_Community_Vulnerability]
INNER JOIN PortfolioProjects..Average_Household_Size_and_Population
ON 
PortfolioProjects..[COVID-19_Community_Vulnerability].County_FIPS = PortfolioProjects..Average_Household_Size_and_Population.GEOID
	)

go

select count(distinct County_FIPS) Unique_County_FIPS from COVID_population

/* Determining national frequency of HHA_Rank: */

select Hardest_Hit_Area, HHA_Rank, count(*) HHA_count from COVID_population group by Hardest_Hit_Area, HHA_Rank 
	order by HHA_count desc

/* Nationally, an HHA_Rank of 3, corresponding to 'ModerateBurden' which identifies communities with moderate
	disease activity, is most frequent at 1,987 counties out of 3,141 (63.3%). 'SustainedHotspot', most severe with a
	ranking of 7, occurs with the second-most frequency and is the case for 456 of 3,141 counties (14.5%). */

/* Each state's national percentage of sustained hotspots is now determined: */

select [State], convert(decimal(10, 2), cast(count(*) as float)/cast(456 as float)*100) National_Sustained_Hotspot_Percentage
	from COVID_population where HHA_Rank = 7 group by [State] order by National_Sustained_Hotspot_Percentage desc

/* Of all sustained hotspots nationally, Michigan and Pensylvania contain the highest percentages, Michigan at 12.72%
	and Pennsylvania at 11.62%. */

/* Concentration of sustained hotspots per state is now determined: */

select 
	[State],
	sum(case when HHA_Rank = 7 then 1 else 0 end) Sustained_Hotspot_Counties,
	count(*) Total_Counties,
	convert(decimal(10, 2), cast(sum(case when HHA_Rank = 7 then 1 else 0 end) as float)/cast(count(*) as float)*100) State_Sustained_Hotspot_Percentage
	from COVID_population 
	group by [State]
	order by State_Sustained_Hotspot_Percentage desc

/* Delaware and New Hampshire have the highest concentrations of COVID sustained hotspots in the U.S. Delaware reflects 
	sustained hotspots for 3 counties of 3 (100%); New Hampshire reflects sustained hotspots for 8 counties of 10 (80%). */

/* DATA FINDINGS VIZUALIZED IN TABLEAU */

/*  Examining correlations with HHA_Rank, these and the corresponding P-values are as follows:
	
	County_Poverty_Proportion: -0.16; P-value < 0.0001
	Average_Household_Size: 0.03; P-value = 0.14
	Total_Population: 0.26; P-value < 0.0001
	Population_Density: 0.12; P-value < 0.0001 */

/* The strongest correlation is between HHA_Rank and Total_Population, at 0.26. The associated low P-value indicates that 
	there is a probability of less than 0.0001 that this correlation is due entirely to random chance. */

/* END OF PROJECT */
